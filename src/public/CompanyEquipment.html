<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/CompanyEquipment.css">
    <link rel="stylesheet" href="styles/common.css">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="./scripts/utils.js"></script>
    <script src="./scripts/common.js" defer></script>
    <script src="./scripts/api.js"></script>
    <title>EcoVolt | Recycle</title>
</head>
<body>

    <aside class="sidebar"></aside>
            <main class="main-content">
                <header class="mainHeader" data-title="Recyce E-Waste" data-breadcrumb="Pages / Recycle E-Waste"></header>

                <nav class="tabs">
                    <a href="CompanyEquipment.html">Company Equipment</a>
                    <a href="EmployeeApplication.html">Employee Application</a>
                    <a href="PendingPickUp.html">Pending Pick Up</a>
                    <a href="Recycled.html">Recycled</a>
                </nav>

                <div class="did-you-know-container">
                    <div class="content-wrapper">
                      <div class="text-section">
                        <div class="text-content">
                          <p class="title">Did you know?</p>
                          <p class="description">
                            Recycling electronics reduces carbon emissions by up to 80% compared to manufacturing new products.
                          </p>
                        </div>
                        <button class="learn-more-btn">
                          <span class="truncate">Learn More</span>
                        </button>
                      </div>
                      <div class="image-section"></div>
                    </div>
                  </div>

              
                
                
                  <section class="equipment-section">
                    <h2 id="recycle-items-heading">Equipment</h2>
                </section>                
    

                    <div class="search-bar">
                        <label>
                            <input type="text" id="search-input" placeholder="Search for a piece of equipment" />
                        </label>
                    </div>     
                    
                    <div class="filter-buttons">
                        <button data-center-id="All" onclick="setActiveButton('All')">All</button>
                        <button data-center-id="1" onclick="setActiveButton('1')">Data Center 1</button>
                        <button data-center-id="2" onclick="setActiveButton('2')">Data Center 2</button>
                        <button data-center-id="3" onclick="setActiveButton('3')">Data Center 3</button>
                        <button data-center-id="4" onclick="setActiveButton('4')">Data Center 4</button>
                        <button data-center-id="5" onclick="setActiveButton('5')">Data Center 5</button>
                    </div>                    
                    
                    
                    <section class="equipment-section">
                    <!-- First table with unique ID -->
                    <div class="equipment-table">
                        <table id="equipment-table-1">
                            <thead>
                                <tr>
                                    <th>Brand</th>
                                    <th>Model</th>
                                    <th>S/N</th>
                                    <th>Age</th>
                                    <th>Carbon Emission</th>
                                    <th>Energy Consumption</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                <div id="details-modal" class="modal hidden">
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeModal()">âœ–</button>
                        <iframe id="modal-iframe" src="" frameborder="0"></iframe>
                    </div>
                </div>
                
            </main>


</body>
</html>
<script>
    let allData = []; // Cache all data for efficient filtering
    let filteredDCData = [];
    const company_id = getCompanyId(); // Get company ID dynamically

    // Fetch and populate the table initially
    async function populateTable() {
        const tableBody = document.querySelector('#equipment-table-1 tbody');

        try {
            if (!company_id) {
                throw new Error('Company ID not found');
            }
            console.log("company_id", company_id);

            const response = await fetch(`/recycle/${company_id}`);
            if (!response.ok) {
                throw new Error(`Failed to fetch data: ${response.status}`);
            }

            const data = await response.json();
            allData = data; // Cache the data for real-time filtering
            renderTable(data); // Populate the table with fetched data
        } catch (error) {
            console.error('Error populating table:', error);
        }
    }


// Render the table with data
function renderTable(data) {
        const tableBody = document.querySelector('#equipment-table-1 tbody');
        tableBody.innerHTML = ''; // Clear existing rows

        if (data.length === 0) {
            // Display "No items found" if the data array is empty
            const noDataRow = document.createElement('tr');
            noDataRow.innerHTML = `
                <td colspan="7" style="text-align: center;">No items found</td>
            `;
            tableBody.appendChild(noDataRow);
            return;
        }

        // Populate the table with data
        data.forEach(item => {
            const row = document.createElement('tr');

            // Add event listener to handle row click
            row.addEventListener('click', () => {
                const serialNumber = row.querySelector('td:nth-child(3)').textContent; // Get serial number
                openModal(serialNumber); // Open the modal with the serial number
            });
            row.innerHTML = `
                <td>${item.brand || 'N/A'}</td>
                <td>${item.model || 'N/A'}</td>
                <td>${item.serial_number || 'N/A'}</td>
                <td>${item.device_age_years || 'N/A'}</td>
                <td>${item.total_device_co2_emissions_tons?.toFixed(2) || 'N/A'}</td>
                <td>${item.total_device_energy_mwh?.toFixed(2) || 'N/A'}</td>
                <td>${item.status || 'N/A'}</td>
            `;
            tableBody.appendChild(row);
        });
    }




function filterTable() {
    const searchTerm = document.querySelector('#search-input').value.trim().toLowerCase();

    // Check if filteredDCData and filteredDCDataRecycled are empty
    if (filteredDCData.length === 0) {
        // Use the cached allData and recycledData if no filtered data is present
        const filteredActiveData = allData.filter(item =>
            (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
            (item.model && item.model.toLowerCase().includes(searchTerm)) ||
            (item.serial_number && item.serial_number.toLowerCase().includes(searchTerm)) ||
            (item.device_age_years && item.device_age_years.toString().includes(searchTerm)) ||
            (item.total_device_co2_emissions_tons && item.total_device_co2_emissions_tons.toString().includes(searchTerm)) ||
            (item.total_device_energy_mwh && item.total_device_energy_mwh.toString().includes(searchTerm)) ||
            (item.status && item.status.toLowerCase().includes(searchTerm))
        );


        // Render the tables using cached data
        renderTable(filteredActiveData); // Update active items table
    } else {
        // Use filteredDCData and filteredDCDataRecycled if they are not empty
        const filteredActiveData = filteredDCData.filter(item =>
            (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
            (item.model && item.model.toLowerCase().includes(searchTerm)) ||
            (item.serial_number && item.serial_number.toLowerCase().includes(searchTerm)) ||
            (item.device_age_years && item.device_age_years.toString().includes(searchTerm)) ||
            (item.total_device_co2_emissions_tons && item.total_device_co2_emissions_tons.toString().includes(searchTerm)) ||
            (item.total_device_energy_mwh && item.total_device_energy_mwh.toString().includes(searchTerm)) ||
            (item.status && item.status.toLowerCase().includes(searchTerm))
        );
        // Render the tables using filtered data
        renderTable(filteredActiveData); // Update active items table
    }
}


    // Set the active class on the clicked button
function setActiveButton(centerId) {
    const buttons = document.querySelectorAll('.filter-buttons button');
    buttons.forEach(button => {
        button.classList.remove('active'); // Remove active class from all buttons
    });

    const activeButton = document.querySelector(`.filter-buttons button[data-center-id="${centerId}"]`);
    if (activeButton) {
        activeButton.classList.add('active'); // Add active class to the clicked button
    }

    // Optionally, call the filter function
    filterByCategory(centerId);
}

// Function to fetch and filter data by data center
async function filterByCategory(dataCenterId) {
    try {
        if (!company_id) {
            throw new Error('Company ID not found');
        }

        if (dataCenterId === "All") {
            filteredDCData = [];
            // If "All" is selected, call the populate functions for all items
            populateTable(); // Populate the active items table with all data
            return;
        }
        filteredDCData = [];
        // Call the endpoint to fetch filtered data
        const filterResponse = await fetch(`/recycle/${company_id}/search/filter/${dataCenterId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ dataCenterId }), // Send data center ID in the body if needed
        });

        if (!filterResponse.ok) {
            throw new Error(`Failed to fetch filtered data: ${filterResponse.status}`);
        }

        // Parse the filtered data and store in global variable
        filteredDCData = await filterResponse.json();


        // Fetch filtered data for active items
        const activeResponse = await fetch(`/recycle/${company_id}/filter/${dataCenterId}`);
        if (!activeResponse.ok) {
            throw new Error(`Failed to fetch active items: ${activeResponse.status}`);
        }
        const activeData = await activeResponse.json();

        // Populate the active items table
        renderTable(activeData);
    } catch (error) {
        console.error('Error filtering data by category:', error);
    }
}

function openModal(serialNumber, isPersonal) {
    const modal = document.getElementById('details-modal');
    const iframe = document.getElementById('modal-iframe');
    // Determine the type of item and include it as a flag
    const itemType = isPersonal ? 'personal' : 'company';
    // Load the content into the iframe with the serial number and flag
    iframe.src = `recycleDetails.html?SN=${serialNumber}&type=${itemType}`;
    modal.classList.remove('hidden'); // Show the modal
    document.body.classList.add('modal-open'); // Disable scrolling on the background
}


function closeModal() {
    const modal = document.getElementById('details-modal');
    const iframe = document.getElementById('modal-iframe');
    iframe.src = ''; // Clear the iframe content
    modal.classList.add('hidden'); // Hide the modal
    document.body.classList.remove('modal-open'); // Re-enable scrolling on the background
}

    // Attach the input event listener to the search field
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('#search-input').addEventListener('input', filterTable);
        setActiveButton('All');
        populateTable(); // Populate the table initially
    });

</script>